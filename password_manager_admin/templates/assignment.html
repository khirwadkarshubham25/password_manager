{% extends 'admin_base.html' %}

{% block title %}Policy Assignments Management{% endblock %}

{% block extra_css %}
<style>
    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        max-width: 400px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
    }

    .filter-group select {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        min-width: 150px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        margin-right: 5px;
    }

    .btn-info {
        background: #17a2b8;
    }

    .btn-info:hover {
        background: #138496;
        box-shadow: 0 5px 20px rgba(23, 162, 184, 0.4);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #28a745;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .modal-header h2 {
        color: #667eea;
        font-size: 1.5em;
        margin: 0;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }

    .close:hover {
        color: #000;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .detail-item label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .detail-item .value {
        font-size: 16px;
        color: #212529;
        font-weight: 500;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-active {
        background: #d4edda;
        color: #155724;
    }

    .status-inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state h3 {
        font-size: 1.5em;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<h2>Policy Assignments Management</h2>

<div class="actions-bar">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç Search assignments...">
    </div>
    <button class="btn btn-primary" onclick="openCreateModal()">
        ‚ûï Create Assignment
    </button>
</div>

<div class="filters">
    <div class="filter-group">
        <label>Sort By</label>
        <select id="sortBySelect" onchange="loadAssignments()">
            <option value="created_at">Created Date</option>
            <option value="policy_name">Policy Name</option>
            <option value="first_name">First Name</option>
            <option value="last_name">Last Name</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Order</label>
        <select id="sortOrderSelect" onchange="loadAssignments()">
            <option value="desc">Descending</option>
            <option value="asc">Ascending</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Page Size</label>
        <select id="pageSizeSelect" onchange="loadAssignments()">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>
</div>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Policy Name</th>
            <th>User Name</th>
            <th>Created At</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody id="assignmentsBody">
        <tr>
            <td colspan="6" style="text-align: center; padding: 40px;">Loading assignments...</td>
        </tr>
    </tbody>
</table>

<div class="pagination" id="pagination"></div>

<!-- Create/Edit Modal -->
<div id="assignmentModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Create Assignment</h2>
            <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <form id="assignmentForm" onsubmit="saveAssignment(event)">
            <input type="hidden" id="assignmentId">
            
            <div class="form-group">
                <label for="policyId">Policy *</label>
                <select id="policyId" required>
                    <option value="">Select Policy</option>
                </select>
            </div>

            <div class="form-group">
                <label for="userId">User *</label>
                <select id="userId" required>
                    <option value="">Select User</option>
                </select>
            </div>

            <div class="form-group">
                <label for="effectiveDate">Effective Date *</label>
                <input type="date" id="effectiveDate" required>
            </div>

            <div class="form-group">
                <label for="expiryDate">Expiry Date</label>
                <input type="date" id="expiryDate">
            </div>

            <div class="form-group" id="statusGroup" style="display: none;">
                <label for="isActive">Active Status</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="isActive" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Assignment</button>
            </div>
        </form>
    </div>
</div>

<!-- View Details Modal -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Assignment Details</h2>
            <button class="close" onclick="closeDetailsModal()">&times;</button>
        </div>
        <div id="assignmentDetails"></div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDetailsModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let totalPages = 1;
    let isEditMode = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadAssignments();
        loadPolicies();
        loadUsers();
        setupSearch();
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        if (!cookieValue && name === 'csrftoken') {
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token) {
                cookieValue = token.getAttribute('content');
            }
        }
        return cookieValue;
    }

    // Load assignments with pagination and sorting
    async function loadAssignments(page = 1) {
        try {
            showLoading(true);
            const sortBy = document.getElementById('sortBySelect').value;
            const sortOrder = document.getElementById('sortOrderSelect').value;
            const pageSize = document.getElementById('pageSizeSelect').value;

            const params = new URLSearchParams({
                page: page.toString(),
                page_size: pageSize,
                sort_by: sortBy,
                sort_order: sortOrder
            });

            const response = await fetch(`/admin/assignments?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                displayAssignments(data.data);
                setupPagination(data.pagination);
                currentPage = data.pagination.page;
                totalPages = data.pagination.total_pages;
            } else {
                showAlert(data.message || 'Failed to load assignments', 'error');
            }
        } catch (error) {
            console.error('Error loading assignments:', error);
            showAlert('Failed to load assignments. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    // Display assignments in table
    function displayAssignments(assignments) {
        const tbody = document.getElementById('assignmentsBody');
        
        if (!assignments || assignments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <h3>No Assignments Found</h3>
                            <p>Create your first policy assignment to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = assignments.map(assignment => `
            <tr>
                <td>${assignment.assignment_id}</td>
                <td><strong>${assignment.policy_name || 'N/A'}</strong></td>
                <td>${assignment.first_name || ''} ${assignment.last_name || ''}</td>
                <td>${formatDate(assignment.created_at)}</td>
                <td>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               ${assignment.is_active ? 'checked' : ''} 
                               onchange="toggleStatus(${assignment.assignment_id}, this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewDetails(${assignment.assignment_id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editAssignment(${assignment.assignment_id})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteAssignment(${assignment.assignment_id})">
                        üóëÔ∏è Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Toggle assignment status
    async function toggleStatus(assignmentId, isActive) {
        const toggle = event.target;
        const originalState = !isActive;
        
        try {
            toggle.disabled = true;
            
            const response = await fetch('/admin/assignment-details', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    assignment_id: assignmentId.toString(),
                    is_active: isActive
                })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(`Assignment ${isActive ? 'activated' : 'deactivated'} successfully`, 'success');
            } else {
                toggle.checked = originalState;
                showAlert(data.message || 'Failed to update status', 'error');
            }
        } catch (error) {
            console.error('Error updating status:', error);
            toggle.checked = originalState;
            showAlert('Failed to update status. Please try again.', 'error');
        } finally {
            toggle.disabled = false;
        }
    }

    // View assignment details
    async function viewDetails(assignmentId) {
        try {
            const params = new URLSearchParams({
                assignment_id: assignmentId.toString()
            });

            const response = await fetch(`/admin/assignment-details?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                const assignment = result.data;
                document.getElementById('assignmentDetails').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Policy Name</label>
                            <div class="value">${assignment.policy_name || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <label>User Name</label>
                            <div class="value">${assignment.first_name || ''} ${assignment.last_name || ''}</div>
                        </div>
                        <div class="detail-item">
                            <label>Effective Date</label>
                            <div class="value">${formatDate(assignment.effective_date)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Expiry Date</label>
                            <div class="value">${formatDate(assignment.expiry_date) || 'No expiry'}</div>
                        </div>
                        <div class="detail-item">
                            <label>Status</label>
                            <div class="value">
                                <span class="status-badge ${assignment.is_active ? 'status-active' : 'status-inactive'}">
                                    ${assignment.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <label>Created At</label>
                            <div class="value">${formatDate(assignment.created_at)}</div>
                        </div>
                    </div>
                `;
                document.getElementById('detailsModal').classList.add('active');
            } else {
                showAlert(result.message || 'Failed to load assignment details', 'error');
            }
        } catch (error) {
            console.error('Error loading details:', error);
            showAlert('Failed to load assignment details. Please try again.', 'error');
        }
    }

    // Open create modal
    function openCreateModal() {
        isEditMode = false;
        document.getElementById('modalTitle').textContent = 'Create Assignment';
        document.getElementById('assignmentForm').reset();
        document.getElementById('assignmentId').value = '';
        document.getElementById('statusGroup').style.display = 'none';
        document.getElementById('isActive').checked = true;
        document.getElementById('assignmentModal').classList.add('active');
    }

    // Edit assignment
    async function editAssignment(assignmentId) {
        try {
            const params = new URLSearchParams({
                assignment_id: assignmentId.toString()
            });

            const response = await fetch(`/admin/assignment-details?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                const assignment = result.data;
                isEditMode = true;
                document.getElementById('modalTitle').textContent = 'Edit Assignment';
                document.getElementById('assignmentId').value = assignment.assignment_id;
                document.getElementById('policyId').value = assignment.policy_id;
                document.getElementById('userId').value = assignment.user_id;
                document.getElementById('effectiveDate').value = assignment.effective_date ? assignment.effective_date.split('T')[0] : '';
                document.getElementById('expiryDate').value = assignment.expiry_date ? assignment.expiry_date.split('T')[0] : '';
                document.getElementById('isActive').checked = assignment.is_active;
                document.getElementById('statusGroup').style.display = 'block';
                document.getElementById('assignmentModal').classList.add('active');
            } else {
                showAlert(result.message || 'Failed to load assignment', 'error');
            }
        } catch (error) {
            console.error('Error loading assignment:', error);
            showAlert('Failed to load assignment. Please try again.', 'error');
        }
    }

    // Save assignment (create or update)
    async function saveAssignment(event) {
        event.preventDefault();

        const assignmentId = document.getElementById('assignmentId').value;
        const policyId = document.getElementById('policyId').value;
        const userId = document.getElementById('userId').value;
        const effectiveDate = document.getElementById('effectiveDate').value;
        const expiryDate = document.getElementById('expiryDate').value;
        const isActive = document.getElementById('isActive').checked;

        const method = isEditMode ? 'PUT' : 'POST';
        const payload = {
            policy_id: parseInt(policyId),
            user_id: parseInt(userId),
            admin_user_id: parseInt(localStorage.getItem('admin_user_id')), // TODO: Get from session
            effective_date: effectiveDate,
            expiry_date: expiryDate || null
        };

        if (isEditMode) {
            payload.assignment_id = parseInt(assignmentId);
            payload.is_active = isActive;
        }

        try {
            const response = await fetch('/admin/assignment-details', {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                closeModal();
                loadAssignments(currentPage);
            } else {
                showAlert(data.message || 'Failed to save assignment', 'error');
            }
        } catch (error) {
            console.error('Error saving assignment:', error);
            showAlert('Failed to save assignment. Please try again.', 'error');
        }
    }

    // Delete assignment
    async function deleteAssignment(assignmentId) {
        if (!confirm('Are you sure you want to delete this assignment?')) {
            return;
        }

        try {
            const response = await fetch('/admin/assignment-details', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    assignment_id: parseInt(assignmentId)
                })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                loadAssignments(currentPage);
            } else {
                showAlert(data.message || 'Failed to delete assignment', 'error');
            }
        } catch (error) {
            console.error('Error deleting assignment:', error);
            showAlert('Failed to delete assignment. Please try again.', 'error');
        }
    }

    // Load policies for dropdown
    async function loadPolicies() {
        try {
            // TODO: Replace with your actual policies endpoint
            const response = await fetch('/admin/policies', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const data = await response.json();

            if (response.ok && data.data) {
                const select = document.getElementById('policyId');
                select.innerHTML = '<option value="">Select Policy</option>' +
                    data.data.map(policy => 
                        `<option value="${policy.policy_id}">${policy.policy_name}</option>`
                    ).join('');
            }
        } catch (error) {
            console.error('Error loading policies:', error);
        }
    }

    // Load users for dropdown
    async function loadUsers() {
        try {
            // TODO: Replace with your actual users endpoint
            const response = await fetch('/admin/users', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const data = await response.json();

            if (response.ok && data.data) {
                const select = document.getElementById('userId');
                select.innerHTML = '<option value="">Select User</option>' +
                    data.data.map(user => 
                        `<option value="${user.user_id}">${user.first_name} ${user.last_name} (${user.email})</option>`
                    ).join('');
            }
        } catch (error) {
            console.error('Error loading users:', error);
        }
    }

    // Setup pagination
    function setupPagination(pagination) {
        const paginationDiv = document.getElementById('pagination');
        
        paginationDiv.innerHTML = `
            <button onclick="loadAssignments(1)" ${pagination.page === 1 ? 'disabled' : ''}>
                ‚èÆÔ∏è First
            </button>
            <button onclick="loadAssignments(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>
                ‚óÄÔ∏è Previous
            </button>
            <span style="padding: 8px 12px;">
                Page ${pagination.page} of ${pagination.total_pages} 
                (${pagination.total} total)
            </span>
            <button onclick="loadAssignments(${pagination.page + 1})" ${pagination.page === pagination.total_pages ? 'disabled' : ''}>
                Next ‚ñ∂Ô∏è
            </button>
            <button onclick="loadAssignments(${pagination.total_pages})" ${pagination.page === pagination.total_pages ? 'disabled' : ''}>
                Last ‚è≠Ô∏è
            </button>
        `;
    }

    // Setup search functionality
    function setupSearch() {
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#assignmentsBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }, 300);
        });
    }

    // Close modals
    function closeModal() {
        document.getElementById('assignmentModal').classList.remove('active');
    }

    function closeDetailsModal() {
        document.getElementById('detailsModal').classList.remove('active');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('assignmentModal');
        const detailsModal = document.getElementById('detailsModal');
        if (event.target === modal) {
            closeModal();
        }
        if (event.target === detailsModal) {
            closeDetailsModal();
        }
    }

    // Format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
{% endblock %}