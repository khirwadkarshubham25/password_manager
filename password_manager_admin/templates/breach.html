{% extends 'admin_base.html' %}

{% block title %}Breach Database Management{% endblock %}

{% block extra_css %}
<style>
    .tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #dee2e6;
    }

    .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s;
    }

    .tab:hover {
        color: #667eea;
    }

    .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .actions-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .search-box {
        flex: 1;
        min-width: 250px;
        max-width: 400px;
    }

    .search-box input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .filters {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .filter-group label {
        font-size: 12px;
        font-weight: 600;
        color: #495057;
        text-transform: uppercase;
    }

    .filter-group select,
    .filter-group input {
        padding: 8px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        min-width: 150px;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        margin-right: 5px;
    }

    .btn-info {
        background: #17a2b8;
    }

    .btn-info:hover {
        background: #138496;
        box-shadow: 0 5px 20px rgba(23, 162, 184, 0.4);
    }

    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 24px;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: 0.4s;
        border-radius: 24px;
    }

    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 18px;
        width: 18px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.4s;
        border-radius: 50%;
    }

    input:checked + .toggle-slider {
        background-color: #28a745;
    }

    input:checked + .toggle-slider:before {
        transform: translateX(26px);
    }

    input:disabled + .toggle-slider {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #dee2e6;
    }

    .modal-header h2 {
        color: #667eea;
        font-size: 1.5em;
        margin: 0;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0;
        line-height: 1;
    }

    .close:hover {
        color: #000;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #667eea;
    }

    .detail-item label {
        display: block;
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        margin-bottom: 5px;
    }

    .detail-item .value {
        font-size: 16px;
        color: #212529;
        font-weight: 500;
        word-wrap: break-word;
    }

    .breach-card {
        background: #f8f9fa;
        border-left: 4px solid #dc3545;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .breach-card:hover {
        background: #e9ecef;
        transform: translateX(5px);
    }

    .breach-card h4 {
        margin: 0 0 10px 0;
        color: #dc3545;
    }

    .breach-card .breach-info {
        display: flex;
        gap: 20px;
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .breach-card .breach-description {
        font-size: 14px;
        color: #495057;
        margin-top: 10px;
    }

    .data-classes {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
    }

    .data-class-tag {
        background: #667eea;
        color: white;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 11px;
    }

    .badge {
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge-verified {
        background: #d4edda;
        color: #155724;
    }

    .badge-sensitive {
        background: #f8d7da;
        color: #721c24;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .empty-state h3 {
        font-size: 1.5em;
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<h2>Breach Database Management</h2>

<div class="tabs">
    <button class="tab active" onclick="switchTab('databases')">Breach Databases</button>
    <button class="tab" onclick="switchTab('hibp')">HIBP Breaches</button>
</div>

<!-- Breach Databases Tab -->
<div id="databases-tab" class="tab-content active">
    <div class="actions-bar">
        <div class="search-box">
            <input type="text" id="searchDatabaseInput" placeholder="üîç Search databases...">
        </div>
        <button class="btn btn-primary" onclick="openCreateDatabaseModal()">
            ‚ûï Add Breach Database
        </button>
    </div>

    <div class="filters">
        <div class="filter-group">
            <label>Sort By</label>
            <select id="sortByDatabaseSelect" onchange="loadDatabases()">
                <option value="source_name">Source Name</option>
                <option value="source_url">Source URL</option>
                <option value="total_hashes">Total Hashes</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Order</label>
            <select id="sortOrderDatabaseSelect" onchange="loadDatabases()">
                <option value="desc">Descending</option>
                <option value="asc">Ascending</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Page Size</label>
            <select id="pageSizeDatabaseSelect" onchange="loadDatabases()">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Source Name</th>
                <th>Source URL</th>
                <th>Total Hashes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="databasesBody">
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">Loading databases...</td>
            </tr>
        </tbody>
    </table>

    <div class="pagination" id="databasePagination"></div>
</div>

<!-- HIBP Breaches Tab -->
<div id="hibp-tab" class="tab-content">
    <div class="actions-bar">
        <div class="search-box">
            <input type="text" id="searchBreachInput" placeholder="üîç Search breaches...">
        </div>
        <div class="filter-group">
            <label>Filter by Domain</label>
            <input type="text" id="domainFilter" placeholder="e.g., adobe.com">
        </div>
        <button class="btn btn-primary" onclick="loadHIBPBreaches()">
            üîÑ Load Breaches
        </button>
    </div>

    <div id="breachesContainer">
        <div class="empty-state">
            <h3>Click "Load Breaches" to fetch data from HIBP</h3>
        </div>
    </div>
</div>

<!-- Create/Edit Database Modal -->
<div id="databaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Breach Database</h2>
            <button class="close" onclick="closeDatabaseModal()">&times;</button>
        </div>
        <form id="databaseForm" onsubmit="saveDatabase(event)">
            <input type="hidden" id="databaseId">

            <div class="form-group">
                <label for="sourceName">Source Name *</label>
                <input type="text" id="sourceName" required>
            </div>

            <div class="form-group">
                <label for="sourceUrl">Source URL *</label>
                <input type="url" id="sourceUrl" required>
            </div>

            <div class="form-group">
                <label for="totalHashes">Total Hashes</label>
                <input type="number" id="totalHashes" min="0" value="0">
            </div>

            <div class="form-group">
                <label for="apiKey">API Key</label>
                <input type="text" id="apiKey">
            </div>

            <div class="form-group">
                <label for="authMethod">Authentication Method</label>
                <select id="authMethod">
                    <option value="NONE">No Authentication</option>
                    <option value="API_KEY">API Key</option>
                    <option value="OAUTH">OAuth</option>
                    <option value="BASIC">Basic Auth</option>
                </select>
            </div>

            <div class="form-group">
                <label for="hashFormat">Hash Format</label>
                <select id="hashFormat">
                    <option value="SHA1">SHA-1</option>
                    <option value="SHA256">SHA-256</option>
                    <option value="MD5">MD5</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="dataStoragePath">Data Storage Path</label>
                <input type="text" id="dataStoragePath">
            </div>

            <div class="form-group" id="statusGroup" style="display: none;">
                <label for="isActive">Active Status</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="isActive" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeDatabaseModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Database</button>
            </div>
        </form>
    </div>
</div>

<!-- View Database Details Modal -->
<div id="databaseDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Database Details</h2>
            <button class="close" onclick="closeDatabaseDetailsModal()">&times;</button>
        </div>
        <div id="databaseDetailsContent"></div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeDatabaseDetailsModal()">Close</button>
        </div>
    </div>
</div>

<!-- View HIBP Breach Details Modal -->
<div id="breachDetailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Breach Details</h2>
            <button class="close" onclick="closeBreachDetailsModal()">&times;</button>
        </div>
        <div id="breachDetailsContent"></div>
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeBreachDetailsModal()">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentDatabasePage = 1;
    let totalDatabasePages = 1;
    let isDatabaseEditMode = false;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadDatabases();
        setupSearch();
    });
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        if (!cookieValue && name === 'csrftoken') {
            const token = document.querySelector('meta[name="csrf-token"]');
            if (token) {
                cookieValue = token.getAttribute('content');
            }
        }
        return cookieValue;
    }

    // Tab switching
    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        if (tab === 'databases') {
            document.querySelector('.tab:nth-child(1)').classList.add('active');
            document.getElementById('databases-tab').classList.add('active');
        } else if (tab === 'hibp') {
            document.querySelector('.tab:nth-child(2)').classList.add('active');
            document.getElementById('hibp-tab').classList.add('active');
        }
    }

    // Load breach databases
    async function loadDatabases(page = 1) {
        try {
            showLoading(true);
            const sortBy = document.getElementById('sortByDatabaseSelect').value;
            const sortOrder = document.getElementById('sortOrderDatabaseSelect').value;
            const pageSize = document.getElementById('pageSizeDatabaseSelect').value;

            const params = new URLSearchParams({
                page: page.toString(),
                page_size: pageSize,
                sort_by: sortBy,
                sort_order: sortOrder
            });

            const response = await fetch(`/admin/breach-databases?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                displayDatabases(data.data);
                setupDatabasePagination(data.pagination);
                currentDatabasePage = data.pagination.page;
                totalDatabasePages = data.pagination.total_pages;
            } else {
                showAlert(data.message || 'Failed to load databases', 'error');
            }
        } catch (error) {
            console.error('Error loading databases:', error);
            showAlert('Failed to load databases. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    // Display databases in table
    function displayDatabases(databases) {
        const tbody = document.getElementById('databasesBody');

        if (!databases || databases.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5">
                        <div class="empty-state">
                            <h3>No Breach Databases Found</h3>
                            <p>Add your first breach database to get started</p>
                        </div>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = databases.map(db => `
            <tr>
                <td>${db.breach_database_id}</td>
                <td><strong>${db.source_name}</strong></td>
                <td>${db.source_url}</td>
                <td>${db.total_hashes.toLocaleString()}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="viewDatabaseDetails(${db.breach_database_id})">
                        üëÅÔ∏è View
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="editDatabase(${db.breach_database_id})">
                        ‚úèÔ∏è Edit
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteDatabase(${db.breach_database_id})">
                        üóëÔ∏è Delete
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // View database details
    async function viewDatabaseDetails(databaseId) {
        try {
            const params = new URLSearchParams({
                breach_database_id: databaseId.toString()
            });

            const response = await fetch(`/admin/breach-database-details?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                const db = result.data;
                document.getElementById('databaseDetailsContent').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Source Name</label>
                            <div class="value">${db.source_name}</div>
                        </div>
                        <div class="detail-item">
                            <label>Source URL</label>
                            <div class="value">${db.source_url}</div>
                        </div>
                        <div class="detail-item">
                            <label>Total Hashes</label>
                            <div class="value">${db.total_hashes.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <label>Authentication Method</label>
                            <div class="value">${db.authentication_method}</div>
                        </div>
                        <div class="detail-item">
                            <label>Hash Format</label>
                            <div class="value">${db.hash_format}</div>
                        </div>
                        <div class="detail-item">
                            <label>Status</label>
                            <div class="value">${db.is_active ? 'Active' : 'Inactive'}</div>
                        </div>
                        <div class="detail-item">
                            <label>Last Updated</label>
                            <div class="value">${formatDate(db.last_updated) || 'Never'}</div>
                        </div>
                        <div class="detail-item">
                            <label>Created At</label>
                            <div class="value">${formatDate(db.created_at)}</div>
                        </div>
                    </div>
                    ${db.description ? `<div style="margin-top: 20px;"><strong>Description:</strong><p>${db.description}</p></div>` : ''}
                `;
                document.getElementById('databaseDetailsModal').classList.add('active');
            } else {
                showAlert(result.message || 'Failed to load database details', 'error');
            }
        } catch (error) {
            console.error('Error loading database details:', error);
            showAlert('Failed to load database details. Please try again.', 'error');
        }
    }

    // Open create database modal
    function openCreateDatabaseModal() {
        isDatabaseEditMode = false;
        document.getElementById('modalTitle').textContent = 'Add Breach Database';
        document.getElementById('databaseForm').reset();
        document.getElementById('databaseId').value = '';
        document.getElementById('statusGroup').style.display = 'none';
        document.getElementById('isActive').checked = true;
        document.getElementById('databaseModal').classList.add('active');
    }

    // Edit database
    async function editDatabase(databaseId) {
        try {
            const params = new URLSearchParams({
                breach_database_id: databaseId.toString()
            });

            const response = await fetch(`/admin/breach-database-details?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                const db = result.data;
                isDatabaseEditMode = true;
                document.getElementById('modalTitle').textContent = 'Edit Breach Database';
                document.getElementById('databaseId').value = db.breach_database_id;
                document.getElementById('sourceName').value = db.source_name;
                document.getElementById('sourceUrl').value = db.source_url;
                document.getElementById('totalHashes').value = db.total_hashes;
                document.getElementById('apiKey').value = db.api_key || '';
                document.getElementById('authMethod').value = db.authentication_method;
                document.getElementById('hashFormat').value = db.hash_format;
                document.getElementById('description').value = db.description || '';
                document.getElementById('dataStoragePath').value = db.data_storage_path || '';
                document.getElementById('isActive').checked = db.is_active;
                document.getElementById('statusGroup').style.display = 'block';
                document.getElementById('databaseModal').classList.add('active');
            } else {
                showAlert(result.message || 'Failed to load database', 'error');
            }
        } catch (error) {
            console.error('Error loading database:', error);
            showAlert('Failed to load database. Please try again.', 'error');
        }
    }

    // Save database (create or update)
    async function saveDatabase(event) {
        event.preventDefault();

        const databaseId = document.getElementById('databaseId').value;
        const method = isDatabaseEditMode ? 'PUT' : 'POST';
        const payload = {
            source_name: document.getElementById('sourceName').value,
            source_url: document.getElementById('sourceUrl').value,
            total_hashes: parseInt(document.getElementById('totalHashes').value),
            api_key: document.getElementById('apiKey').value || null,
            authentication_method: document.getElementById('authMethod').value,
            hash_format: document.getElementById('hashFormat').value,
            description: document.getElementById('description').value,
            data_storage_path: document.getElementById('dataStoragePath').value || null
        };

        if (isDatabaseEditMode) {
            payload.breach_database_id = databaseId;
            payload.is_active = document.getElementById('isActive').checked;
        }

        try {
            const response = await fetch('/admin/breach-database-details', {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                closeDatabaseModal();
                loadDatabases(currentDatabasePage);
            } else {
                showAlert(data.message || 'Failed to save database', 'error');
            }
        } catch (error) {
            console.error('Error saving database:', error);
            showAlert('Failed to save database. Please try again.', 'error');
        }
    }

    // Delete database
    async function deleteDatabase(databaseId) {
        if (!confirm('Are you sure you want to delete this breach database?')) {
            return;
        }

        try {
            const response = await fetch('/admin/breach-database-details', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                },
                body: JSON.stringify({
                    breach_database_id: databaseId.toString()
                })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert(data.message, 'success');
                loadDatabases(currentDatabasePage);
            } else {
                showAlert(data.message || 'Failed to delete database', 'error');
            }
        } catch (error) {
            console.error('Error deleting database:', error);
            showAlert('Failed to delete database. Please try again.', 'error');
        }
    }

    // Load HIBP breaches
    async function loadHIBPBreaches() {
        try {
            showLoading(true);
            const domain = document.getElementById('domainFilter').value.trim();

            let url = '/admin/get_breaches';
            if (domain) {
                url += `?domain=${encodeURIComponent(domain)}`;
            }

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                displayHIBPBreaches(data.data);
            } else {
                showAlert(data.message || 'Failed to load breaches', 'error');
            }
        } catch (error) {
            console.error('Error loading HIBP breaches:', error);
            showAlert('Failed to load breaches. Please try again.', 'error');
        } finally {
            hideLoading();
        }
    }

    // Display HIBP breaches
    function displayHIBPBreaches(breaches) {
        const container = document.getElementById('breachesContainer');

        if (!breaches || breaches.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>No Breaches Found</h3>
                    <p>Try adjusting your domain filter or click "Load Breaches" again</p>
                </div>
            `;
            return;
        }

        container.innerHTML = breaches.map(breach => `
            <div class="breach-card" onclick="viewBreachDetails('${breach.name}')">
                <h4>${breach.title}</h4>
                <div class="breach-info">
                    <span><strong>Date:</strong> ${breach.breach_date}</span>
                    <span><strong>Accounts:</strong> ${breach.pwn_count.toLocaleString()}</span>
                    <span><strong>Domain:</strong> ${breach.domain || 'N/A'}</span>
                    ${breach.is_verified ? '<span class="badge badge-verified">Verified</span>' : ''}
                    ${breach.is_sensitive ? '<span class="badge badge-sensitive">Sensitive</span>' : ''}
                </div>
                <div class="breach-description">
                    ${breach.description ? breach.description.substring(0, 200) + '...' : 'No description available'}
                </div>
                ${breach.data_classes && breach.data_classes.length > 0 ? `
                    <div class="data-classes">
                        ${breach.data_classes.slice(0, 5).map(dc => `<span class="data-class-tag">${dc}</span>`).join('')}
                        ${breach.data_classes.length > 5 ? `<span class="data-class-tag">+${breach.data_classes.length - 5} more</span>` : ''}
                    </div>
                ` : ''}
            </div>
        `).join('');
    }

    // View breach details
    async function viewBreachDetails(breachName) {
        try {
            const params = new URLSearchParams({
                breach_name: breachName
            });

            const response = await fetch(`/admin/get_breach_details?${params.toString()}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Authorization': `Bearer ${getToken()}`
                }
            });

            const result = await response.json();

            if (response.ok) {
                const breach = result.data;
                document.getElementById('breachDetailsContent').innerHTML = `
                    <div class="detail-grid">
                        <div class="detail-item">
                            <label>Title</label>
                            <div class="value">${breach.title}</div>
                        </div>
                        <div class="detail-item">
                            <label>Domain</label>
                            <div class="value">${breach.domain || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <label>Breach Date</label>
                            <div class="value">${breach.breach_date}</div>
                        </div>
                        <div class="detail-item">
                            <label>Affected Accounts</label>
                            <div class="value">${breach.pwn_count.toLocaleString()}</div>
                        </div>
                        <div class="detail-item">
                            <label>Added to HIBP</label>
                            <div class="value">${formatDate(breach.added_date)}</div>
                        </div>
                        <div class="detail-item">
                            <label>Verified</label>
                            <div class="value">${breach.is_verified ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <strong>Description:</strong>
                        <p>${breach.description}</p>
                    </div>
                    ${breach.data_classes && breach.data_classes.length > 0 ? `
                        <div style="margin-top: 20px;">
                            <strong>Compromised Data:</strong>
                            <div class="data-classes" style="margin-top: 10px;">
                                ${breach.data_classes.map(dc => `<span class="data-class-tag">${dc}</span>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                `;
                document.getElementById('breachDetailsModal').classList.add('active');
            } else {
                showAlert(result.message || 'Failed to load breach details', 'error');
            }
        } catch (error) {
            console.error('Error loading breach details:', error);
            showAlert('Failed to load breach details. Please try again.', 'error');
        }
    }

    // Setup database pagination
    function setupDatabasePagination(pagination) {
        const paginationDiv = document.getElementById('databasePagination');

        paginationDiv.innerHTML = `
            <button onclick="loadDatabases(1)" ${pagination.page === 1 ? 'disabled' : ''}>
                ‚èÆÔ∏è First
            </button>
            <button onclick="loadDatabases(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>
                ‚óÄÔ∏è Previous
            </button>
            <span style="padding: 8px 12px;">
                Page ${pagination.page} of ${pagination.total_pages}
                (${pagination.total} total)
            </span>
            <button onclick="loadDatabases(${pagination.page + 1})" ${pagination.page === pagination.total_pages ? 'disabled' : ''}>
                Next ‚ñ∂Ô∏è
            </button>
            <button onclick="loadDatabases(${pagination.total_pages})" ${pagination.page === pagination.total_pages ? 'disabled' : ''}>
                Last ‚è≠Ô∏è
            </button>
        `;
    }

    // Setup search functionality
    function setupSearch() {
        const searchDatabaseInput = document.getElementById('searchDatabaseInput');
        const searchBreachInput = document.getElementById('searchBreachInput');
        let searchTimeout;

        searchDatabaseInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase();
                const rows = document.querySelectorAll('#databasesBody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }, 300);
        });

        searchBreachInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = this.value.toLowerCase();
                const cards = document.querySelectorAll('.breach-card');

                cards.forEach(card => {
                    const text = card.textContent.toLowerCase();
                    card.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }, 300);
        });
    }

    // Close modals
    function closeDatabaseModal() {
        document.getElementById('databaseModal').classList.remove('active');
    }

    function closeDatabaseDetailsModal() {
        document.getElementById('databaseDetailsModal').classList.remove('active');
    }

    function closeBreachDetailsModal() {
        document.getElementById('breachDetailsModal').classList.remove('active');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const databaseModal = document.getElementById('databaseModal');
        const databaseDetailsModal = document.getElementById('databaseDetailsModal');
        const breachDetailsModal = document.getElementById('breachDetailsModal');

        if (event.target === databaseModal) {
            closeDatabaseModal();
        }
        if (event.target === databaseDetailsModal) {
            closeDatabaseDetailsModal();
        }
        if (event.target === breachDetailsModal) {
            closeBreachDetailsModal();
        }
    }

    // Format date
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }
</script>
{% endblock %}